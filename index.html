<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>StackEdit.js Loader + CodeMirror 6</title>
  <!-- Beer CSS et Material Dynamic Colors -->
  <link href="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.css" rel="stylesheet" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
  <style>
    body {
      max-width: 800px;
      margin: 2rem auto;
      font-family: sans-serif;
    }
    /* Conteneur redimensionnable pour CodeMirror 6 */
    #editor {
      resize: vertical;
      overflow: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-height: 300px;
    }
    .button-container {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      cursor: pointer;
      background: #333;
      color: #fff;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <h1>StackEdit.js Loader</h1>
    <p>
      Chargez un fichier Markdown en passant dans l’URL l’un des formats suivants :<br>
      <code>#!url:https://url-du-fichier.md</code> ou <code>#!gist:username/gist-id</code>
    </p>
  </header>
  <main>
    <!-- Zone d'édition pour CodeMirror 6 -->
    <div id="editor"></div>
    <div class="button-container">
      <button id="editStackEdit">Ouvrir dans StackEdit</button>
      <button id="copyTextButton">✂️ Copier</button>
    </div>
  </main>
  <!-- StackEdit.js -->
  <script src="https://unpkg.com/stackedit-js@1.0.7/docs/lib/stackedit.min.js"></script>
  <!-- CodeMirror 6 : on importe les modules via des scripts de type "module" -->
  <script type="module">
    import { EditorState } from "https://cdn.jsdelivr.net/npm/@codemirror/state@6.2.0/dist/index.js";
    import { EditorView, keymap } from "https://cdn.jsdelivr.net/npm/@codemirror/view@6.10.0/dist/index.js";
    import { defaultKeymap } from "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.2.0/dist/index.js";
    import { history, historyKeymap } from "https://cdn.jsdelivr.net/npm/@codemirror/history@6.2.0/dist/index.js";
    import { markdown, markdownLanguage } from "https://cdn.jsdelivr.net/npm/@codemirror/lang-markdown@6.2.0/dist/index.js";
    import { languages } from "https://cdn.jsdelivr.net/npm/@codemirror/language-data@6.3.0/dist/index.js";
    import { oneDark } from "https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/dist/index.js";

    // Création de l'état initial avec quelques extensions utiles
    const startState = EditorState.create({
      doc: "",
      extensions: [
        keymap.of([...defaultKeymap, ...historyKeymap]),
        history(),
        markdown({ base: markdownLanguage, codeLanguages: languages }),
        oneDark,
        EditorView.lineWrapping
      ]
    });

    // Création de l'éditeur dans le conteneur #editor
    const editor = new EditorView({
      state: startState,
      parent: document.getElementById("editor")
    });

    // Fonction pour remplacer le contenu de l'éditeur
    function updateEditorContent(content) {
      const transaction = editor.state.update({
        changes: { from: 0, to: editor.state.doc.length, insert: content }
      });
      editor.dispatch(transaction);
    }

    // Fonction pour récupérer le contenu de l'éditeur
    function getEditorContent() {
      return editor.state.doc.toString();
    }

    // Intégration avec StackEdit
    const stackedit = new Stackedit();
    stackedit.on("fileChange", file => {
      updateEditorContent(file.content.text || "");
    });

    // Fonction de chargement d'un fichier Markdown depuis une URL
    function loadMarkdown(url) {
      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error("Erreur lors du chargement du fichier.");
          return response.text();
        })
        .then(data => {
          updateEditorContent(data);
        })
        .catch(error => {
          console.error("Erreur :", error);
          updateEditorContent("Erreur lors du chargement du fichier : " + error.message);
        });
    }

    // Fonction de chargement d'un gist GitHub
    function loadGist(username, gistId) {
      const apiUrl = "https://api.github.com/gists/" + gistId;
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) throw new Error("Erreur lors du chargement du gist.");
          return response.json();
        })
        .then(data => {
          const files = data.files;
          const fileNames = Object.keys(files);
          if (fileNames.length > 0) {
            updateEditorContent(files[fileNames[0]].content);
          } else {
            updateEditorContent("Aucun fichier trouvé dans ce gist.");
          }
        })
        .catch(error => {
          console.error("Erreur :", error);
          updateEditorContent("Erreur lors du chargement du gist : " + error.message);
        });
    }

    // Analyse du hash dans l'URL pour charger du contenu
    if (window.location.hash) {
      const hash = window.location.hash;
      if (hash.startsWith("#!url:")) {
        const fileUrl = hash.replace("#!url:", "");
        loadMarkdown(fileUrl);
      } else if (hash.startsWith("#!gist:")) {
        const gistInfo = hash.replace("#!gist:", "");
        const parts = gistInfo.split("/");
        if (parts.length === 2) {
          const username = parts[0];
          const gistId = parts[1];
          loadGist(username, gistId);
        } else {
          updateEditorContent("Format de gist invalide. Utilisez : #!gist:username/gist-id");
        }
      }
    }

    // Bouton : Ouvrir dans StackEdit
    document.getElementById("editStackEdit").addEventListener("click", () => {
      const content = getEditorContent();
      stackedit.openFile({
        name: "Document Markdown",
        content: { text: content }
      });
    });

    // Bouton : Copier le contenu dans le presse-papiers
    document.getElementById("copyTextButton").addEventListener("click", () => {
      const content = getEditorContent();
      navigator.clipboard.writeText(content)
        .then(() => {
          document.getElementById("copyTextButton").innerText = "✅ Copié";
          setTimeout(() => {
            document.getElementById("copyTextButton").innerText = "✂️ Copier";
          }, 2000);
        })
        .catch(error => {
          console.error("Erreur lors de la copie du texte :", error);
        });
    });
  </script>
</body>
</html>
