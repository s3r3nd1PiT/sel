<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>StackEdit.js Loader</title>
  <!-- Beer CSS et Material Dynamic Colors -->
  <link href="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.css" rel="stylesheet" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.9.6/dist/cdn/beer.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>

  <!-- Highlight.js avec le thème github-dark -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

  <style>
    body {
      max-width: 800px;
      margin: 2rem auto;
    }

    /* Conteneur de l'éditeur */
    #editor-container {
      position: relative;
      border: 1px solid #ccc;
      border-radius: 3px;
      overflow: hidden;
      font-family: monospace;
      line-height: 1.5;
    }

    /* Bloc de code coloré par highlight.js */
    #editor-container pre {
      margin: 0;
      padding: 1rem;
      /* Empêche la sélection et les clics dans le bloc de code */
      pointer-events: none;
      user-select: none;

      /* Pour que le texte "wrap" comme dans le textarea */
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      min-height: 15em;
    }

    /* Le <code> lui-même */
    #highlighted-code {
      font-size: 1rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Le textarea transparent pour la saisie */
    #editor-container textarea {
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      padding: 1rem;
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      resize: vertical;
      background: transparent;
      /* Masque le texte, même lors de la sélection */
      color: transparent;
      -webkit-text-fill-color: transparent;
      caret-color: #fff;

      /* Même font-size et line-height que le bloc code */
      font-family: monospace;
      font-size: 1rem;
      line-height: 1.5;

      /* Pour gérer les retours à la ligne comme le code */
      white-space: pre-wrap;
      word-wrap: break-word;

      z-index: 2;
    }

    /* Boutons en bas */
    .button-container {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
      border: none;
      cursor: pointer;
      background: #333;
      color: #fff;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <header>
    <h1>StackEdit.js Loader</h1>
    <p>
      Chargez un fichier Markdown en passant dans l’URL l’un des formats suivants :<br>
      <code>#!url:https://url-du-fichier.md</code> ou <code>#!gist:username/gist-id</code>
    </p>
  </header>

  <main>
    <!-- Zone d'édition avec overlay pour la coloration syntaxique -->
    <div id="editor-container">
      <pre>
        <code id="highlighted-code" class="markdown"></code>
      </pre>
      <textarea id="markdown" placeholder="Le contenu Markdown chargé s’affichera ici..." rows="15"></textarea>
    </div>
    <div class="button-container">
      <button id="editStackEdit">Ouvrir dans StackEdit</button>
      <button id="copyTextButton">✂️ Copier</button>
    </div>
  </main>

  <!-- StackEdit.js -->
  <script src="https://unpkg.com/stackedit-js@1.0.7/docs/lib/stackedit.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var textarea = document.getElementById("markdown");
      var codeElement = document.getElementById("highlighted-code");
      var stackedit = new Stackedit();

      // Met à jour le bloc de code avec la coloration via highlight.js
      function updateHighlighting() {
        codeElement.textContent = textarea.value;
        hljs.highlightElement(codeElement);
      }

      // Synchronisation du défilement entre textarea et bloc de code
      textarea.addEventListener("scroll", function() {
        var pre = document.querySelector("#editor-container pre");
        pre.scrollTop = textarea.scrollTop;
        pre.scrollLeft = textarea.scrollLeft;
      });

      // Actualisation en temps réel lors de la saisie
      textarea.addEventListener("input", updateHighlighting);

      // Mise à jour lors d'un changement dans StackEdit
      stackedit.on('fileChange', function(file) {
        textarea.value = file.content.text;
        updateHighlighting();
      });

      // Fonction de chargement d'un fichier Markdown depuis une URL
      function loadMarkdown(url) {
        fetch(url)
          .then(function(response) {
            if (!response.ok) {
              throw new Error("Erreur lors du chargement du fichier.");
            }
            return response.text();
          })
          .then(function(data) {
            textarea.value = data;
            updateHighlighting();
          })
          .catch(function(error) {
            console.error("Erreur :", error);
            textarea.value = "Erreur lors du chargement du fichier : " + error.message;
            updateHighlighting();
          });
      }

      // Fonction de chargement d'un gist GitHub
      function loadGist(username, gistId) {
        var apiUrl = "https://api.github.com/gists/" + gistId;
        fetch(apiUrl)
          .then(function(response) {
            if (!response.ok) {
              throw new Error("Erreur lors du chargement du gist.");
            }
            return response.json();
          })
          .then(function(data) {
            var files = data.files;
            var fileNames = Object.keys(files);
            if (fileNames.length > 0) {
              textarea.value = files[fileNames[0]].content;
            } else {
              textarea.value = "Aucun fichier trouvé dans ce gist.";
            }
            updateHighlighting();
          })
          .catch(function(error) {
            console.error("Erreur :", error);
            textarea.value = "Erreur lors du chargement du gist : " + error.message;
            updateHighlighting();
          });
      }

      // Analyse de la partie hash de l'URL pour charger un fichier ou un gist
      if (window.location.hash) {
        var hash = window.location.hash;
        if (hash.startsWith("#!url:")) {
          var fileUrl = hash.replace("#!url:", "");
          loadMarkdown(fileUrl);
        } else if (hash.startsWith("#!gist:")) {
          var gistInfo = hash.replace("#!gist:", "");
          var parts = gistInfo.split("/");
          if (parts.length === 2) {
            var username = parts[0];
            var gistId = parts[1];
            loadGist(username, gistId);
          } else {
            textarea.value = "Format de gist invalide. Utilisez : #!gist:username/gist-id";
            updateHighlighting();
          }
        }
      }

      // Bouton pour ouvrir le contenu dans StackEdit
      document.getElementById("editStackEdit").addEventListener("click", function() {
        var content = textarea.value;
        stackedit.openFile({
          name: "Document Markdown",
          content: {
            text: content
          }
        });
      });

      // Bouton pour copier le contenu du textarea
      var copyBtn = document.getElementById("copyTextButton");
      copyBtn.addEventListener("click", function() {
        navigator.clipboard.writeText(textarea.value)
          .then(function() {
            copyBtn.innerText = "✅ Copié";
            setTimeout(function() {
              copyBtn.innerText = "✂️ Copier";
            }, 2000);
          })
          .catch(function(error) {
            console.error("Erreur lors de la copie du texte :", error);
          });
      });
    });
  </script>
</body>
</html>
